name: release

on:
  push:
    branches: [main]
  workflow_dispatch: {}

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.AUTOSHIP_GH_TOKEN || secrets.GITHUB_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          registry-url: "https://registry.npmjs.org"

      - name: npm latest
        run: |
          npm i -g npm@latest
          npm -v

      - uses: oven-sh/setup-bun@v2

      - name: Install deps
        run: MDV_SKIP_DOWNLOAD=1 bun install --frozen-lockfile

      - name: Changesets version PR
        uses: changesets/action@v1
        with:
          version: bun run release:version
          commit: "chore: version packages"
          title: "chore: version packages"
          createGithubReleases: false
        env:
          GITHUB_TOKEN: ${{ secrets.AUTOSHIP_GH_TOKEN || secrets.GITHUB_TOKEN }}

  publish_npm:
    runs-on: ubuntu-latest
    needs: [version]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          registry-url: "https://registry.npmjs.org"
          check-latest: true

      - name: npm latest
        run: |
          npm i -g npm@latest
          npm -v

      - uses: oven-sh/setup-bun@v2

      - name: Install deps
        run: MDV_SKIP_DOWNLOAD=1 bun install --frozen-lockfile

      - name: Skip if version PR open
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          pr="$(gh pr list --repo "$GITHUB_REPOSITORY" --head "changeset-release/main" --base "main" --state open --json number --jq '.[0].number' || true)"
          if [ -n "${pr:-}" ]; then
            echo "skip: version pr open ($pr)"
            exit 0
          fi

      - name: OIDC debug
        run: |
          set -euo pipefail
          echo "node=$(node -v)"
          echo "npm=$(npm -v)"
          echo "has_id_token_url=$([ -n "${ACTIONS_ID_TOKEN_REQUEST_URL:-}" ] && echo yes || echo no)"
          echo "has_node_auth_token=$([ -n "${NODE_AUTH_TOKEN:-}" ] && echo yes || echo no)"
          npm config get registry

      - name: Auth npm (token, optional)
        if: ${{ secrets.NPM_TOKEN != '' }}
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          rc="${NPM_CONFIG_USERCONFIG:-$HOME/.npmrc}"
          echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" >> "$rc"

      - name: Publish (trusted publisher)
        run: |
          set -euo pipefail
          local_v="$(node -p "require('./packages/cli/package.json').version")"
          remote_v="$(npm view @dhruv2mars/mdv version 2>/dev/null || true)"
          if [ -n "${remote_v:-}" ] && [ "${remote_v}" = "${local_v}" ]; then
            echo "skip: already on npm (${remote_v})"
            exit 0
          fi
          (cd packages/cli && npm publish --provenance --access public)

  tag:
    runs-on: ubuntu-latest
    needs: [publish_npm]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Tag (vX.Y.Z)
        run: |
          set -euo pipefail
          v="$(node -p "require('./packages/cli/package.json').version")"
          tag="v${v}"
          if git ls-remote --tags origin "${tag}" | grep -q .; then
            echo "skip: tag exists (${tag})"
            exit 0
          fi
          git tag "${tag}"
          git push origin "${tag}"
