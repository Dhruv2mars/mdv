name: release

on:
  push:
    branches: [main]
  workflow_dispatch: {}

concurrency: ${{ github.workflow }}-${{ github.ref }}

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.AUTOSHIP_GH_TOKEN || secrets.GITHUB_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: oven-sh/setup-bun@v2

      - name: Install deps
        run: MDV_SKIP_DOWNLOAD=1 bun install --frozen-lockfile

      - name: Changesets version PR
        uses: changesets/action@v1
        with:
          version: bun run release:version
          commit: "chore: version packages"
          title: "chore: version packages"
          createGithubReleases: false
        env:
          GITHUB_TOKEN: ${{ secrets.AUTOSHIP_GH_TOKEN || secrets.GITHUB_TOKEN }}

  publish:
    runs-on: ubuntu-latest
    needs: [version]
    environment: npm
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.AUTOSHIP_GH_TOKEN || secrets.GITHUB_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: npm (trusted publisher)
        run: |
          npm i -g npm@^11.5.1
          npm -v

      - uses: oven-sh/setup-bun@v2

      - name: Install deps
        run: MDV_SKIP_DOWNLOAD=1 bun install --frozen-lockfile

      - name: Skip if version PR open
        env:
          GH_TOKEN: ${{ secrets.AUTOSHIP_GH_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          pr="$(gh pr list --repo "$GITHUB_REPOSITORY" --head "changeset-release/main" --base "main" --state open --json number --jq '.[0].number' || true)"
          if [ -n "${pr:-}" ]; then
            echo "skip: version pr open ($pr)"
            exit 0
          fi

      - name: Publish (OIDC)
        run: |
          set -euo pipefail
          unset NODE_AUTH_TOKEN NPM_TOKEN
          local_v="$(node -p "require('./packages/cli/package.json').version")"
          remote_v="$(npm view @dhruv2mars/mdv version 2>/dev/null || true)"
          if [ -n "${remote_v:-}" ] && [ "${remote_v}" = "${local_v}" ]; then
            echo "skip: already on npm (${remote_v})"
            exit 0
          fi
          (cd packages/cli && npm publish --provenance --access public)

      - name: Tag (vX.Y.Z)
        run: |
          set -euo pipefail
          v="$(node -p "require('./packages/cli/package.json').version")"
          tag="v${v}"
          if git ls-remote --tags origin "${tag}" | grep -q .; then
            echo "skip: tag exists (${tag})"
            exit 0
          fi
          git tag "${tag}"
          git push origin "${tag}"
