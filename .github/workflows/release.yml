name: release

on:
  push:
    branches: [main]
  workflow_dispatch: {}

concurrency: ${{ github.workflow }}-${{ github.ref }}

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: oven-sh/setup-bun@v2

      - name: Install deps
        run: MDV_SKIP_DOWNLOAD=1 bun install --frozen-lockfile

      - name: Changesets version PR
        uses: changesets/action@v1
        with:
          version: bun run release:version
          commit: "chore: version packages"
          title: "chore: version packages"
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Auto-merge version PR
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          pr="$(gh pr list --repo "$GITHUB_REPOSITORY" --head "changeset-release/main" --base "main" --state open --json number --jq '.[0].number' || true)"
          if [ -z "${pr:-}" ]; then
            echo "no version pr"
            exit 0
          fi
          gh pr merge "$pr" --merge --auto

  publish:
    runs-on: ubuntu-latest
    needs: [version]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: oven-sh/setup-bun@v2

      - name: Install deps
        run: MDV_SKIP_DOWNLOAD=1 bun install --frozen-lockfile

      - name: Skip if version PR open
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          pr="$(gh pr list --repo "$GITHUB_REPOSITORY" --head "changeset-release/main" --base "main" --state open --json number --jq '.[0].number' || true)"
          if [ -n "${pr:-}" ]; then
            echo "skip: version pr open ($pr)"
            exit 0
          fi

      - name: npmrc (OIDC)
        run: |
          cat << 'EOF' > "$HOME/.npmrc"
          registry=https://registry.npmjs.org/
          EOF

      - name: Publish (OIDC, no tokens)
        env:
          NPM_CONFIG_PROVENANCE: "true"
        run: |
          unset NODE_AUTH_TOKEN NPM_TOKEN
          bun run release:publish

      - name: Tag (vX.Y.Z)
        run: |
          v="$(node -p "require('./packages/cli/package.json').version")"
          tag="v${v}"
          if git ls-remote --tags origin "${tag}" | rg -q .; then
            echo "skip: tag exists (${tag})"
            exit 0
          fi
          git tag "${tag}"
          git push origin "${tag}"
